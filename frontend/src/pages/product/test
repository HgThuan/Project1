// Product.jsx
import { Fragment, useEffect, useState, useCallback } from "react";
import Productt from "../../until/layoutauto";
import useProductFilter from "../../until/fillter";
import { Link, useSearchParams } from "react-router-dom";
import AddProduct from "../../until/cart";
import axios from 'axios';
import ReactPaginate from 'react-paginate';

export default function Product() {
    Productt();
    useProductFilter();
    AddProduct();
    
    const [data, setData] = useState([]);
    const [categories, setCategories] = useState([]);
    const [totalProduct, setTotalProduct] = useState(0);
    const [pageCount, setPageCount] = useState(0);
    const [searchParams, setSearchParams] = useSearchParams();
    const [loading, setLoading] = useState(false);
    const [activeFilters, setActiveFilters] = useState({});

    const itemsPageSize = 10;

    useEffect(() => {
        const loadCategories = async () => {
            try {
                const response = await axios.get("http://localhost:5001/api/getalldm");
                setCategories(response.data);
            } catch (err) {
                console.error("Lỗi tải danh mục:", err);
            }
        };
        loadCategories();
    }, []);

    const loadData = useCallback(async () => {
        setLoading(true);
        try {
            const page = searchParams.get('page') || 1;
            const category = searchParams.get('category');
            const gender = searchParams.get('gender');
            const filter = searchParams.get('filter');
            const search = searchParams.get('search');
            const sort = searchParams.get('sort');

            let url = '';
            const params = { page, limit: itemsPageSize };

            setActiveFilters({ category, gender, filter, search, sort });

            if (search) {
                url = `http://localhost:5001/api/searchsp/${search}`;
            } else if (category) {
                url = `http://localhost:5001/api/sanpham/danhmuc/${category}`;
            } else if (gender) {
                url = `http://localhost:5001/api/sanpham/gender/${gender}`;
            } else if (filter === 'sale') {
                url = `http://localhost:5001/api/sanpham/filter/sale`;
            } else if (sort === 'newest') {
                url = `http://localhost:5001/api/sanpham/filter/new`;
            } else if (sort === 'best-seller') {
                url = `http://localhost:5001/api/sanpham/filter/best-seller`;
            } else if (sort === 'discount') {
                url = `http://localhost:5001/api/sanpham/filter/sale`;
            } else {
                url = `http://localhost:5001/api/getallsp`;
                if (sort === 'price-asc' || sort === 'price-desc') {
                    params.sort = sort;
                }
            }

            const response = await axios.get(url, { params });
            setData(response.data.products);
            setTotalProduct(response.data.pagination.total);
            setPageCount(response.data.pagination.pages);
        } catch (error) {
            console.error("Lỗi khi lấy dữ liệu", error);
        } finally {
            setLoading(false);
        }
    }, [searchParams]);

    const handlePageClick = (event) => {
        setSearchParams(params => {
            params.set('page', event.selected + 1);
            return params;
        });
    };

    useEffect(() => {
        if (!searchParams.has('page')) {
            setSearchParams(params => {
                params.set('page', '1');
                return params;
            });
        } else {
            loadData();
        }
    }, [searchParams, setSearchParams, loadData]);

    const formatCurrency = (number) => {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
    };

    const getPageTitle = () => {
        if (activeFilters.search) return `Kết quả tìm kiếm: "${activeFilters.search}"`;
        if (activeFilters.gender === 'Nam') return 'Thời trang Nam';
        if (activeFilters.gender === 'Nữ') return 'Thời trang Nữ';
        if (activeFilters.filter === 'sale') return 'Sản phẩm đang giảm giá';
        if (activeFilters.category) {
            const cat = categories.find(c => c.ma_danh_muc === activeFilters.category);
            return cat?.ten_danh_muc || 'Danh mục';
        }
        if (activeFilters.sort === 'newest') return 'Sản phẩm mới nhất';
        if (activeFilters.sort === 'best-seller') return 'Sản phẩm bán chạy';
        return 'Tất cả sản phẩm';
    };

    return (
        <Fragment>
            <div className="all-product-container" style={{ paddingBottom: '30px' }}>
                {/* Active Filters */}
                {(activeFilters.search || activeFilters.gender || activeFilters.filter || activeFilters.category || activeFilters.sort) && (
                    <div className="active-filters" style={{ background: '#f8f9fa', padding: '15px', marginBottom: '20px', borderRadius: '8px', border: '1px solid #e9ecef' }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                            <div>
                                <strong>Bộ lọc:</strong> <span style={{ marginLeft: '10px', color: '#495057' }}>{getPageTitle()}</span>
                            </div>
                            <button onClick={() => setSearchParams({ page: '1' })} style={{ background: '#dc3545', color: 'white', border: 'none', padding: '5px 10px', borderRadius: '4px', cursor: 'pointer' }}>
                                Xóa tất cả
                            </button>
                        </div>
                    </div>
                )}

                <div className="container1">
                    {loading && (
                        <div style={{ textAlign: 'center', padding: '40px' }}>
                            <div className="spinner-border text-primary" role="status"></div>
                            <p>Đang tải...</p>
                        </div>
                    )}

                    {!loading && data.length === 0 && (
                        <div style={{ textAlign: 'center', padding: '40px' }}>
                            <h3>Không tìm thấy sản phẩm</h3>
                            <button onClick={() => setSearchParams({ page: '1' })} className="btn btn-primary">Xem tất cả</button>
                        </div>
                    )}

                    <div className="product-type">
                        <div className="row">
                            {data.map((item) => {
                                const hasDiscount = item.giam_gia > 0;
                                const newPrice = hasDiscount ? item.gia * (1 - item.giam_gia / 100) : item.gia;

                                return (
                                    <div key={item.ma_san_pham} className="col p-2-4">
                                        <div className="product">
                                            <div className="product-img-wrap">
                                                <Link to={`/detail/${item.ma_san_pham}`} className="product-img product-img--small">
                                                    <img className="product-img-1" src={item.anh_sanpham} alt={item.ten_san_pham} />
                                                    <img className="product-img-2" src={item.anhhover1 || item.anh_sanpham} alt={item.ten_san_pham} />
                                                </Link>
                                            </div>
                                            <div className="product-content">
                                                <Link to={`/detail/${item.ma_san_pham}`} className="product-name">
                                                    {item.ten_san_pham}
                                                </Link>
                                                <div className="product-price-wrap">
                                                    {hasDiscount ? (
                                                        <>
                                                            <div className="product-price product-price--new">{formatCurrency(newPrice)}</div>
                                                            <div className="product-price product-price--old">{formatCurrency(item.gia)}</div>
                                                        </>
                                                    ) : (
                                                        <div className="product-price">{formatCurrency(item.gia)}</div>
                                                    )}
                                                </div>
                                                {hasDiscount && <div className="sale-tag product-tag">-{item.giam_gia}%</div>}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>

                {pageCount > 1 && (
                    <ReactPaginate
                        breakLabel="..."
                        nextLabel="Trang tiếp >"
                        onPageChange={handlePageClick}
                        pageRangeDisplayed={5}
                        pageCount={pageCount}
                        previousLabel="< Trước"
                        containerClassName="pagination"
                        pageLinkClassName="page-num"
                        previousLinkClassName="page-num"
                        nextLinkClassName="page-num"
                        activeLinkClassName="active"
                        forcePage={parseInt(searchParams.get('page') || '1') - 1}
                    />
                )}
            </div>
        </Fragment>
    );
}